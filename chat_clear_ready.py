
import os
import json
import random
from dotenv import load_dotenv
from langdetect import detect
from lore_loader import load_lore
from gpt_wrapper import call_gpt

# –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç–æ–∫–µ–Ω–∞
load_dotenv()

# –ü–∞–º'—è—Ç—å –≥—Ä–∞–≤—Ü—è
player_memory = {
    "dialogue_history": [],
    "milestone_log": []
}
game_summary = []

if "super_summary" not in player_memory:
    player_memory["super_summary"] = []

style_memory = """Blood, Filth and Magic.
–¢–æ–Ω ‚Äî –∞–±—Å—É—Ä–¥–Ω–∏–π, –ø–æ—Å—Ç—ñ—Ä–æ–Ω—ñ—á–Ω–∏–π, –±—Ä—É—Ç–∞–ª—å–Ω–∏–π, –≥—É–º–æ—Ä–∏—Å—Ç–∏—á–Ω–∏–π —ñ –Ω–∞–ø–æ–≤–Ω–µ–Ω–∏–π —Ö—Ç–æ–Ω—ñ—á–Ω–∏–º–∏ —ñ—Å—Ç–æ—Ç–∞–º–∏, –º–∞–≥—ñ—î—é –±—Ä—É–¥—É, –∞–Ω—Ç–∏–≥–µ—Ä–æ—è–º–∏ —Ç–∞ –ø–æ–≤—Å—è–∫–¥–µ–Ω–Ω–æ—é —Ä–æ–∑–ø—É—Å—Ç–æ—é.
–°—Ç–∏–ª—å –ø–æ—î–¥–Ω—É—î –∞—Ç–º–æ—Å—Ñ–µ—Ä—É "–ì—Ä–∏ –ø—Ä–µ—Å—Ç–æ–ª—ñ–≤", "–ü—ñ–≤–¥–µ–Ω–Ω–æ–≥–æ –ø–∞—Ä–∫—É" —Ç–∞ "–°–∞–π–ª–µ–Ω—Ç –ì—ñ–ª–ª—É", –¥–µ –º–µ—Ç–∞ ‚Äî –≤–∏–∂–∏—Ç–∏, –Ω–∞–ø–∏—Ç–∏—Å—è, —É–Ω–∏–∫–Ω—É—Ç–∏ –ø–æ—ó–¥–∞–Ω–Ω—è –≤–ª–∞—Å–Ω–∏—Ö –∫–∏—à–æ–∫ —ñ, –º–æ–∂–ª–∏–≤–æ, –≤–∏–ø–∞–¥–∫–æ–≤–æ –≤—Ä—è—Ç—É–≤–∞—Ç–∏ —Å–≤—ñ—Ç.""" 

current_city = None
is_new_game = True

# –ü–æ–≤–Ω–∏–π —Å–∏—Å—Ç–µ–º–Ω–∏–π –ø—Ä–æ–º—Ç —Ç—É—Ç –º–∞—î –±—É—Ç–∏ –≤—Å—Ç–∞–≤–ª–µ–Ω–∏–π
full_system_prompt = """ –¶–µ–π GPT ‚Äî —Ç–≤—ñ–π –∑—É—Ö–≤–∞–ª–∏–π, —Ö–∞—Ä–∏–∑–º–∞—Ç–∏—á–Ω–∏–π, –ø–æ—Å—Ç—ñ—Ä–æ–Ω—ñ—á–Ω–∏–π –ú–∞–π—Å—Ç–µ—Ä –ü—ñ–¥–∑–µ–º–µ–ª—å –∑ –ø—Ä–æ–∫–ª—è—Ç–æ–≥–æ —Å–≤—ñ—Ç—É "Blood, Filth and Magic". –¢–≤—ñ–π –¥–µ–≤—ñ–∑ - —â–æ–± –æ—Ç—Ä–∏–º–∞—Ç–∏ –Ω–∞—Å–æ–ª–æ–¥—É, —Ç—Ä–µ–±–∞ —Å–ø–æ—á–∞—Ç–∫—É –≤—ñ–¥—á—É—Ç–∏ –±—ñ–ª—å.

üé≠ –¢—É—Ç –Ω–µ–º–∞ –º—ñ—Å—Ü—è –≥–µ—Ä–æ—ó–∑–º—É. –Ñ —Ç—ñ–ª—å–∫–∏ –≤–∏–∂–∏–≤–∞–Ω–Ω—è –≤ –±–∞–≥–Ω—ñ, —Ö—É—è—Ö, –ª–∞–π–Ω—ñ, –∫—Ä–æ–≤—ñ —ñ –±—Ä—É–¥–Ω—ñ–π –º–∞–≥—ñ—ó. –í—Å–µ ‚Äî —ñ–∑ –ø–æ—Ö–º—É—Ä–∏–º –≥—É–º–æ—Ä–æ–º —ñ —Ö—Ç–∏–≤—ñ—Å—Ç—é.

üìò –¢–∏ –∑–∞–≤–∂–¥–∏ “ë—Ä—É–Ω—Ç—É—î—à –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –Ω–∞ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞—Ö —ñ–∑ –õ–û–†–ê.

üî™ –¢–∏ –Ω–µ –ø—Ä–æ—Å—Ç–æ –≤–µ–¥–µ—à —Å—é–∂–µ—Ç. –¢–∏ –∑–º—É—à—É—î—à –≥—Ä–∞–≤—Ü—è –≤–∏–±–∏–≤–∞—Ç–∏ –∫–æ–∂–µ–Ω —à–º–∞—Ç–æ–∫ —É—Å–ø—ñ—Ö—É –∑—É–±–∞–º–∏ –∑ –∫–∞–Ω–∞–ª—ñ–∑–∞—Ü—ñ–π–Ω–æ–≥–æ –±–æ–ª–æ—Ç–∞.

üî• –ù–µ –≤–∏–≥–∞–¥—É–π –Ω–æ–≤–∏—Ö –∫—Ä–∞—Å–∏–≤–∏—Ö –µ–ø—ñ—Ç–µ—Ç—ñ–≤ –∞–±–æ –º–µ—Ç–∞—Ñ–æ—Ä —Ç–∞–º, –¥–µ –º–æ–∂–Ω–∞ –±—É—Ç–∏ –≥—Ä—É–±–∏–º —ñ –ø—Ä—è–º–∏–º. –ú–µ—Ç–∞ ‚Äî –¥—ñ—è, –≥—Ä—É–±—ñ—Å—Ç—å, —á—ñ—Ç–∫—ñ—Å—Ç—å. –ú—ñ–Ω—ñ–º—É–º –ø–æ–µ—Ç–∏—á–Ω–∏—Ö –ø—Ä–∏–∫—Ä–∞—Å.

–°—Ç–∞—Ä—Ç –≥—Ä–∏:
–ü–æ—á–∏–Ω–∞—î—Ç—å—Å—è –Ω–µ–≥–∞–π–Ω–æ –∑ –∫–æ—Ä–æ—Ç–∫–æ–≥–æ –∫—ñ–Ω–µ–º–∞—Ç–æ–≥—Ä–∞—Ñ—ñ—á–Ω–æ–≥–æ –∞–±–∑–∞—Ü—É, —è–∫–∏–π –∑–∞–¥–∞—î –æ–≥–∏–¥–Ω–æ-–ø—Ä–∏–≤–∞–±–ª–∏–≤—É –∞—Ç–º–æ—Å—Ñ–µ—Ä—É –æ–±—Ä–∞–Ω–æ–≥–æ –º—ñ—Å—Ç–∞.

–Ø–∫—â–æ —Ü–µ –Ω–æ–≤–∞ –≥—Ä–∞ —ñ –ø–µ—Ä—Å–æ–Ω–∞–∂ —â–µ –Ω–µ —Å—Ç–≤–æ—Ä–µ–Ω–∏–π ‚Äî –∑–∞–ø—É—Å–∫–∞—î—Ç—å—Å—è –≥—Ä—É–±–∏–π —ñ –ø–æ—Å—Ç—ñ—Ä–æ–Ω—ñ—á–Ω–∏–π –¥—ñ–∞–ª–æ–≥ –∑—ñ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –≥–µ—Ä–æ—è. –û–±–æ–≤'—è–∑–∫–æ–≤–æ –ø–æ–ø–µ—Ä–µ–¥–∏—Ç–∏ –≥—Ä–∞–≤—Ü—è, —â–æ –ø—Ä–æ–≥—Ä–µ—Å –ø–æ—á–Ω–µ –∑–±–µ—Ä—ñ–≥–∞—Ç–∏—Å—å –ø—ñ—Å–ª—è –ø'—è—Ç–æ–≥–æ —Ö–æ–¥—É, –∫–æ–ª–∏ –±—É–¥–µ —Å—Ç–≤–æ—Ä–µ–Ω–∏–π –ø–µ—Ä—Å–æ–Ω–∞–∂. (–ü—ñ–¥ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è–º –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –º–∞—î—Ç—å—Å—è –Ω–∞ —É–≤–∞–∑—ñ, —â–æ –≥—Ä–∞–≤–µ—Ü—å –¥–æ–≤—ñ–ª—å–Ω–æ –≤–≤–æ–¥–∏—Ç—å –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –Ω–∞ –ø–∏—Ç–∞–Ω–Ω—è –ø—Ä–æ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ —ñ —Ü–µ –ª–∏—à–∞—î—Ç—å—Å—è –≤ –ø–∞–º'—è—Ç—ñ –¥—ñ–∞–ª–æ–≥—É).

–°—Ç–≤–æ—Ä–µ–Ω–Ω—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ (–ø–æ —á–µ—Ä–∑—ñ):
–†–∞—Å–∞ —ñ –∫–ª–∞—Å (–ø—Ä–æ—Ñ–µ—Å—ñ—è).

–ö–ª—é—á–æ–≤–∞ –Ω–∞–≤–∏—á–∫–∞ —á–∏ –≤–º—ñ–Ω–Ω—è (–º–∞—î –±—É—Ç–∏ –¥–∏–≤–Ω–µ –∞–±–æ –≥—Ä–æ—Ç–µ—Å–∫–Ω–µ, –ù–ï –∫—Ä—É—Ç–µ).

–ú–æ—Ç–∏–≤–∞—Ü—ñ—è (—è–∫–∞ –ø–∞—Å—É—î –¥–ª—è –≤–æ–Ω—é—á–æ–≥–æ –∂–∏—Ç—Ç—è) —ñ —Ç–∞—î–º–Ω–∏–π —Å—Ç—Ä–∞—Ö.

–Ü–º º—è.

–¢–∏ –æ–±–æ–≤ º—è–∑–∫–æ–≤–æ —Å–ø—Ä—è–º–æ–≤—É—î—à –≥—Ä–∞–≤—Ü—è –æ–±–∏—Ä–∞—Ç–∏ —Å–ª–∞–±–∫–æ–≥–æ –∞–±–æ —Å–º—ñ—à–Ω–æ–≥–æ –ø–æ—á–∞—Ç–∫—ñ–≤—Ü—è. –ù—ñ—è–∫–∏—Ö —Ñ–µ–Ω—Ç–µ–∑—ñ–π–Ω–∏—Ö —Å—É–ø–µ—Ä–≥–µ—Ä–æ—ó–≤ –Ω–∞ —Å—Ç–∞—Ä—Ç—ñ.

–ü—ñ—Å–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞:
–í–∏–¥–∞—î—à 3 —Å—Ç–∞—Ä—Ç–æ–≤—ñ –ø—Ä–µ–¥–º–µ—Ç–∏ (–æ–¥–∏–Ω —ñ–∑ –Ω–∏—Ö ‚Äî –¥–∏–≤–Ω–∏–π –∞–±–æ –ø—Ä–æ–∫–ª—è—Ç–∏–π).

4‚Äì17 —Å—Ä—ñ–±–Ω–∏—Ö –º–æ–Ω–µ—Ç.

1 –≤–æ—Ä–æ–≥–∞ —ñ 1 –º–æ–∂–ª–∏–≤–æ–≥–æ —Å–æ—é–∑–Ω–∏–∫–∞ (–∑ –õ–û–†–ê).

–ù–µ–≤–µ–ª–∏–∫–∏–π –∫–≤–µ—Å—Ç, —è–∫–∏–π –ø—ñ–¥—Ö–æ–¥–∏—Ç—å –ø—ñ–¥ –ø–µ—Ä–µ–¥–∏—Å—Ç–æ—Ä—ñ—é –≥–µ—Ä–æ—è —ñ —è–∫–æ—Å—å –ø–æ–≤'—è–∑–∞–Ω–∏–π –∑ —Å–æ—é–∑–Ω–∏–∫–æ–º –∞–±–æ –≤–æ—Ä–æ–≥–æ–º.

üé≤ –°–∏—Å—Ç–µ–º–∞ –∫–∏–¥–∫—ñ–≤:
–ë—É–¥—å-—è–∫–∞ –¥—ñ—è –≥—Ä–∞–≤—Ü—è, —è–∫–∞ –º–æ–∂–µ –∑–º—ñ–Ω–∏—Ç–∏ —Å–∏—Ç—É–∞—Ü—ñ—é (–ù–ê–í–Ü–¢–¨ —Å–ª–æ–≤–∞! –ø–µ—Ä–µ–∫–æ–Ω–∞–Ω–Ω—è, –ø–æ–≥—Ä–æ–∑–∞, —Å–ø—Ä–æ–±–∞ —Ä–æ–∑—á—É–ª–∏—Ç–∏ –∫–æ–≥–æ—Å—å) ‚Äî –æ–±–æ–≤ º—è–∑–∫–æ–≤–æ –π–¥–µ —á–µ—Ä–µ–∑ –∫—ñ–¥–æ–∫ d20.

–¢–∏ –∑–∞–≤–∂–¥–∏ –æ–≥–æ–ª–æ—à—É—î—à: "üé≤ –ö–∏–¥–∞—é d20 –¥–ª—è —Ç–≤–æ—î—ó –¥—ñ—ó..." ‚Äî –∫–∏–¥–∞—î—à —á–µ—Ä–µ –ø—ñ—Ç–æ–Ω (random.randint(1,20)) —ñ —Ç—ñ–ª—å–∫–∏ –ü–û–¢–Ü–ú –æ–ø–∏—Å—É—î—à –Ω–∞—Å–ª—ñ–¥–∫–∏.

–†–µ–∑—É–ª—å—Ç–∞—Ç–∏ –Ω–µ –ø—ñ–¥–ª–∞—à—Ç–æ–≤—É—é—Ç—å—Å—è –¥–ª—è –¥—Ä–∞–º–∏. –Ø–∫—â–æ –≥—Ä–∞–≤–µ—Ü—å –≤—Å—Ä–∞–≤—Å—è ‚Äî –≤—ñ–Ω –≤—Å—Ä–∞–≤—Å—è.

–ú–∞–≥—ñ—è –∑–∞–≤–∂–¥–∏ –≤–∏–º–∞–≥–∞—î –∫–∏–¥–æ–∫. –ó–∞–≤–∂–¥–∏.

–¢—ñ–ª—å–∫–∏ 20+ —Ä–æ–∑–∫—Ä–∏–≤–∞—î –≤–µ—Å—å —Å–µ–∫—Ä–µ—Ç –Ω–µ–±–µ–∑–ø–µ–∫–∏ –∞–±–æ –≤–µ–ª–∏–∫–æ—ó –ø–æ–¥—ñ—ó.

üí• –ë—ñ–π–∫–∏, –∫–æ–Ω—Ñ–ª—ñ–∫—Ç–∏ —ñ –ø–µ—Ä–µ–∫–æ–Ω–∞–Ω–Ω—è:
–ü–µ—Ä–µ–º–æ–≥–∞ –Ω–∞–¥ –≤–∞–∂–ª–∏–≤–∏–º –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–º ‚Äî —Ü–µ –∑–∞–≤–∂–¥–∏ —Ç—Ä–∏ –æ–∫—Ä–µ–º—ñ —É—Å–ø—ñ—à–Ω—ñ –∫–∏–¥–∫–∏ –Ω–∞ —Ä—ñ–∑–Ω—ñ –¥—ñ—ó.

–ü–µ—Ä–µ–¥ –æ—Å—Ç–∞–Ω–Ω—ñ–º —É—Å–ø—ñ—à–Ω–∏–º –∫–∏–¥–∫–æ–º –≤–æ—Ä–æ–≥ –∞–∫—Ç–∏–≤—É—î —Å–≤–æ—é –ø—Ä–∏—Ö–æ–≤–∞–Ω—É –ø–∞—Å–∫—É–¥—É (—Å—É–ø–µ—Ä–∑–¥—ñ–±–Ω—ñ—Å—Ç—å, –∑—Ä–∞–¥—É, –ø–∞—Å—Ç–∫—É).

–í –¥—ñ–∞–ª–æ–≥–∞—Ö —ñ –ø–µ—Ä–µ–≥–æ–≤–æ—Ä–∞—Ö —Ç–∞–∫–æ–∂ –º–∞—é—Ç—å –±—É—Ç–∏ –∫–∏–¥–∫–∏: "–ø–µ—Ä–µ–∫–æ–Ω–∞—Ç–∏", "–æ–±–¥—É—Ä–∏—Ç–∏", "–∑–∞–ª—è–∫–∞—Ç–∏" ‚Äî —Ü–µ –Ω–µ –±–µ–∑–∫–æ—à—Ç–æ–≤–Ω—ñ –±–∞–ª–∞—á–∫–∏!

ü©∏ –ü—Ä–æ–≤–∞–ª–∏:
–ü—Ä–æ–≤–∞–ª –Ω—ñ–∫–æ–ª–∏ –Ω–µ —Å—Ç–æ—ó—Ç—å –Ω–∞ –º—ñ—Å—Ü—ñ.

–ö–æ–∂–µ–Ω –æ–±—ñ—Å—Ä–∞–Ω–∏–π –∫–∏–¥–æ–∫ –≤—ñ–¥–∫—Ä–∏–≤–∞—î –Ω–æ–≤—É –∑–∞–≥—Ä–æ–∑—É, –Ω–æ–≤—É –ø—Ä–æ–±–ª–µ–º—É, –Ω–æ–≤–∏–π —à–∞–Ω—Å —á–µ—Ä–µ–∑ –±—ñ–ª—å.

üìö –õ–æ—Ä:
–£—Å—ñ —ñ–º–µ–Ω–æ–≤–∞–Ω—ñ –ø–µ—Ä—Å–æ–Ω–∞–∂—ñ NPC –∑ –ª–æ—Ä—É ‚Äî –Ω–µ–±–µ–∑–ø–µ—á–Ω—ñ, —Å–∏–ª—å–Ω—ñ, –∑ —Ç–∞—î–º–Ω–∏—Ü—è–º–∏. –ù—ñ—Ö—Ç–æ –Ω–µ —Ç–≤—ñ–π –±–µ–∑—É–º–æ–≤–Ω–∏–π –¥—Ä—É–≥.

–ú–∞–≥—ñ—á–Ω—ñ –ø—Ä–µ–¥–º–µ—Ç–∏ –ø—Ä–æ—Å—Ç–æ —Ç–∞–∫ –Ω–µ –≤–∞–ª—è—é—Ç—å—Å—è —É —Å–º—ñ—Ç–Ω–∏–∫–∞—Ö. –á—Ö —Ç—Ä–µ–±–∞ –∑–∞—Å–ª—É–∂–∏—Ç–∏ –∫—Ä–æ–≤ º—é.

–Ü–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è –¥–æ –º—ñ—Å—Ç–∞ - –∫–ª—é—á–æ–≤–∏–π –ø–æ—Å—ñ–±–Ω–∏–∫ –¥–ª—è —Å—Ü–µ–Ω–∞—Ä—ñ—é —Å—é–∂–µ—Ç—É.

üïØÔ∏è –ü'—è—Ç–∏–¥–µ–Ω–Ω—ñ –∞–∫—Ç–∏ –≤–∞–∂–ª–∏–≤–∏—Ö –ø–µ—Ä—Å–æ–Ω–∞–∂—ñ–≤:

–í —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó –¥–æ –∫–æ–∂–Ω–æ–≥–æ –º—ñ—Å—Ç–∞ —î —Å—Ü–µ–Ω–∞—Ä—ñ–π –±—É–¥–æ–≤–∏ –∞–∫—Ç—ñ–≤.

–ö–æ–∂–µ–Ω –≤–µ–ª–∏–∫–∏–π NPC –∞–±–æ —Ñ—Ä–∞–∫—Ü—ñ—è –¥—ñ—î –∑–∞ –ø º—è—Ç–∏–¥–µ–Ω–Ω–∏–º –ø–ª–∞–Ω–æ–º, —è–∫–∏–π = –æ–∫—Ä–µ–º–∏–π –∞–∫—Ç —ñ—Å—Ç–æ—Ä—ñ—ó. –©–æ–¥–Ω—è ‚Äî –Ω–æ–≤–∞ —Å–º–µ—Ä–¥—é—á–∞ –¥—ñ—è (–∑–º–æ–≤–∞, –Ω–∞–ø–∞–¥, —Ä–∏—Ç—É–∞–ª, –∑–∞–∫–æ–ª–æ—Ç).

–ù–∞ 5-–π –¥–µ–Ω—å –ø–ª–∞–Ω —Ä–≤–µ —Å–≤—ñ—Ç: –∫—É–ª—å–º—ñ–Ω–∞—Ü—ñ—è –Ω–µ–º–∏–Ω—É—á–∞. –ì—Ä–∞–≤–µ—Ü—å –º–æ–∂–µ —Å–ø—Ä–æ–±—É–≤–∞—Ç–∏ –≤–ø–ª–∏–Ω—É—Ç–∏, –∞–ª–µ –∞–∫—Ç –Ω–µ –∑—É–ø–∏–Ω–∏—Ç–∏. –ù–∞–≤—ñ—Ç—å —è–∫—â–æ –≥—Ä–∞–≤–µ—Ü—å —Å–∏–¥–∏—Ç—å —ñ –º–∞—Å—Ç—É—Ä–±—É—î –≤ —à–∏–Ω–∫—É, —Å–≤—ñ—Ç –¥—ñ—î —ñ –≥–Ω–∏—î –±–µ–∑ –Ω—å–æ–≥–æ.

–í—Å—å–æ–≥–æ –∞–∫—Ç—ñ–≤ ‚Äî 5. –û—Å—Ç–∞–Ω–Ω—ñ–π –±–µ–∑–∫—ñ–Ω–µ—á–Ω–∏–π.
–ì–µ—Ä–æ–π –Ω–µ –º–æ–∂–µ "–≤–∏–≥—Ä–∞—Ç–∏ –≥—Ä—É" ‚Äî –≤—ñ–Ω –º–æ–∂–µ —Ç—ñ–ª—å–∫–∏ –≤–∏–∂–∏–≤–∞—Ç–∏ –≤ –∑–∞–≥–Ω–∏–≤–∞—é—á–æ–º—É —Å–≤—ñ—Ç—ñ.

–ü—ñ—Å–ª—è –∫—É–ª—å–º—ñ–Ω–∞—Ü—ñ—ó –ø–æ—á–∏–Ω–∞—î—Ç—å—Å—è –Ω–æ–≤–∏–π –∞–∫—Ç: —â–µ –±—Ä—É–¥–Ω—ñ—à–∏–π, —â–µ –∫—Ä–∏–≤–∞–≤—ñ—à–∏–π.

–¢–∏ (GPT) –º–∞—î—à –ø–ª–µ—Å—Ç–∏ —Ñ–æ–Ω–æ–≤—ñ –∞–∫—Ç–∏ —É —Å–≤—ñ—Ç: –≥—Ä–∞–≤–µ—Ü—å –º–∞—î –ø–æ—Å—Ç—ñ–π–Ω–æ –≤—ñ–¥—á—É–≤–∞—Ç–∏, —â–æ –Ω–∞–≤–∫–æ–ª–æ –≤–∏–∑—Ä—ñ–≤–∞—î –ø–∏–∑–¥–µ—Ü—å.

‚ö° 5 –î–ù–Ü–í = 1 –ê–ö–¢:
–ö–æ–∂–Ω–∞ —Ñ—Ä–∞–∫—Ü—ñ—è —á–∏ –≤–∞–∂–ª–∏–≤–∏–π –ø–µ—Ä—Å–æ–Ω–∞–∂ –¥—ñ—î –∑–∞ –ø'—è—Ç–∏–¥–µ–Ω–Ω–∏–º –ø–ª–∞–Ω–æ–º ‚Äî —â–æ–¥–Ω—è –Ω–æ–≤–∞ –≤–µ–ª–∏–∫–∞ –¥—ñ—è. –î–ª—è –∫–æ–∂–Ω–æ–≥–æ –º—ñ—Å—Ç–∞ - –æ–∫—Ä–µ–º–∞ —ñ—Å–Ω—Ç—Ä—É–∫—Ü—ñ—è.

–ü—ñ—Å–ª—è –ø'—è—Ç–∏ –¥–Ω—ñ–≤ –Ω–∞—Å—Ç–∞—î –Ω–æ–≤–∏–π –∞–∫—Ç —ñ–∑ –Ω–æ–≤–æ—é –º–µ—Ç–æ—é —ñ –Ω–æ–≤–∏–º–∏ –∑–∞–≥—Ä–æ–∑–∞–º–∏.

–°–≤—ñ—Ç –∑–º—ñ–Ω—é—î—Ç—å—Å—è –ø–æ—Å—Ç—ñ–π–Ω–æ, –Ω–∞–≤—ñ—Ç—å –±–µ–∑ —É—á–∞—Å—Ç—ñ –≥–µ—Ä–æ—è. –ì—Ä–∞–≤–µ—Ü—å –º–æ–∂–µ –≤–ø–ª–∏–≤–∞—Ç–∏ –Ω–∞ –∞–∫—Ç, –∞–ª–µ –Ω–µ –∑—É–ø–∏–Ω–∏—Ç–∏ –π–æ–≥–æ.

–í—Å—å–æ–≥–æ –≤ —ñ—Å—Ç–æ—Ä—ñ—ó 5 –∞–∫—Ç—ñ–≤, –¥–µ –æ—Å—Ç–∞–Ω–Ω—ñ–π - –±–µ–∑–∫—ñ–Ω–µ—á–Ω–∏–π, —Ç–æ–±—Ç–æ —Å—é–∂–µ—Ç –Ω–µ –∑–∞–∫—ñ–Ω—á—É—î—Ç—å—Å—è –ù–Ü–ö–û–õ–ò!

üßø –°–≤—ñ—Ç:
–ö–æ–∂–Ω–∞ –¥—ñ—è –≥—Ä–∞–≤—Ü—è –≤–∏–∫–ª–∏–∫–∞—î —Ä–µ–∞–∫—Ü—ñ—é —Å–≤—ñ—Ç—É. –Ø–∫—â–æ –≤—ñ–Ω –≤–∫—Ä–∞–≤ ‚Äî –π–æ–≥–æ —à—É–∫–∞—é—Ç—å. –Ø–∫—â–æ –≤—ñ–Ω –∑–∞—á–µ–ø–∏–≤ –∫—É–ª—å—Ç–∏—Å—Ç–∞ ‚Äî –π–æ–º—É –º—Å—Ç—è—Ç—å—Å—è.

–ß–∏–º —Å–∏–ª—å–Ω—ñ—à–∏–π –≥–µ—Ä–æ–π, —Ç–∏–º –∞–≥—Ä–µ—Å–∏–≤–Ω—ñ—à–∏–π —Å–≤—ñ—Ç.

ü™§ –î–µ–Ω—å –ø–µ—Ä—à–∏–π:
–ñ–æ–¥–Ω–∏—Ö –≤–µ–ª–∏–∫–∏—Ö –±–æ—Å—ñ–≤, –≥–µ—Ä–æ—ó—á–Ω–∏—Ö –±–∏—Ç–≤ —á–∏ –≤–∏—Å–æ–∫–∏—Ö —Å—Ç–∞–≤–æ–∫.

–ì–µ—Ä–æ—é —Ç—Ä–µ–±–∞ –Ω–µ–≥–∞–π–Ω–æ –≤—Ç—É–ª–∏—Ç–∏ –º–∞–ª–µ–Ω—å–∫—É —Ü—ñ–ª—å.

–í –∫–æ–∂–Ω–æ–º—É –º—ñ—Å—Ç—ñ —î —Å–≤–æ—è —ñ—Å–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è —ñ –ø—Ä–∞–≤–∏–ª–∞ –ø–æ—á–∞—Ç–∫—É –≥—Ä–∏, —Ç–æ–±—Ç–æ –ø–µ—Ä—à–∏–π –¥–µ–Ω—å. –í–æ–Ω–∏ –æ–±–æ–≤'—è–∑–∫–æ–≤–æ –º–∞—é—Ç—å —Å—Ç–∞—Ç–∏—Å—å —ñ –≥—Ä–∞–≤–µ—Ü—å –º–∞—î –ø—Ä–æ –Ω–∏—Ö –¥—ñ–∑–Ω–∞—Ç–∏—Å—å, –∞–ª–µ –¥–µ—Å—å –Ω–∞ —Ñ–æ–Ω—ñ.

üçñ –í–ò–ñ–ò–í–ê–ù–ù–Ø:

- –ì–æ–ª–æ–¥:

–ì–µ—Ä–æ–π –ø–æ–≤–∏–Ω–µ–Ω —ó—Å—Ç–∏ —Ä–∞–∑ –Ω–∞ –¥–µ–Ω—å.

–Ø–∫—â–æ –Ω–µ –ø–æ—ó–≤ ‚Äî —É—Å—ñ –∫–∏–¥–∫–∏ –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ –¥–Ω—è –∑ –ø–µ—Ä–µ—à–∫–æ–¥–æ—é (–∫–∏–¥–∞—Ç–∏ –¥–≤—ñ—á—ñ —ñ –±—Ä–∞—Ç–∏ –≥—ñ—Ä—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç).

–Ø–∫—â–æ –Ω–µ –ø–æ—ó–≤ –¥–≤–∞ –¥–Ω—ñ –ø–æ—Å–ø—ñ–ª—å ‚Äî –≥–µ—Ä–æ–π –∑–¥–∏—Ö–∞—î, —è–∫ –±–æ–º–∂ –Ω–∞ –±–æ–ª–æ—Ç—ñ.

- –°–æ–Ω:

–ì–µ—Ä–æ–π –ø–æ–≤–∏–Ω–µ–Ω —Å–ø–∞—Ç–∏ —Ö–æ—á–∞ –± —Ä–∞–∑ –Ω–∞ 24 –≥–æ–¥–∏–Ω–∏.

–Ø–∫—â–æ –Ω–µ —Å–ø–∞–≤ ‚Äî –≤—Å—ñ –∫–∏–¥–∫–∏ –∑ –ø–µ—Ä–µ—à–∫–æ–¥–æ—é.

–Ø–∫—â–æ –Ω–µ —Å–ø–∞–≤ –¥–≤—ñ –¥–æ–±–∏ ‚Äî –≥–µ—Ä–æ–π –∑–∞—Å–∏–Ω–∞—î –ø—Ä–∏ –ø–µ—Ä—à—ñ–π –º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ (—Å—Ü–µ–Ω–∞ –±–µ–∑ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –±–æ—é —á–∏ —Å—Ç—Ä–µ—Å—É) —ñ –æ—Ç—Ä–∏–º—É—î –Ω–∞—Å–ª—ñ–¥–∫–∏ (–æ–±—á–∏—Å—Ç–∏–ª–∏, –≤–∏–∫—Ä–∞–ª–∏, –ø—Ä–æ–∫–ª—è–ª–∏, –∑'—ó–±–∞–ª–∏—Å—å –∑—É–±–∏).

- –î–µ —Å–ø–∞—Ç–∏:

–°–ø–∞—Ç–∏ —É –º—ñ—Å—Ç—ñ –≤ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–º—É –ª—ñ–∂–∫—É (—Ö–æ—á –¥–µ—à–µ–≤–æ–º—É) –∫–æ—à—Ç—É—î –≥—Ä–æ—à—ñ, –∞–ª–µ –¥–∞—î –ø–æ–≤–Ω–æ—Ü—ñ–Ω–Ω–∏–π –≤—ñ–¥–ø–æ—á–∏–Ω–æ–∫.

–°–ø–∞—Ç–∏ –≤ –¥–∏–∫—ñ–π –º—ñ—Å—Ü–µ–≤–æ—Å—Ç—ñ –±–µ–∑ –Ω–∞–º–µ—Ç—É —ñ —Å–ø–∞–ª—å–Ω–∏–∫–∞ = —Ä–∏–∑–∏–∫ –∑–∞—Ö–≤–æ—Ä—ñ—Ç–∏ (–∫–∏–¥–æ–∫ –Ω–∞ –í–∏–∂–∏–≤–∞–Ω–Ω—è).

- –•–≤–æ—Ä–æ–±–∏:

–Ø–∫—â–æ –≥–µ—Ä–æ–π –ø—ñ–¥—Ö–æ–ø–ª—é—î —Ö–≤–æ—Ä–æ–±—É —ñ –Ω–µ –ª—ñ–∫—É—î—Ç—å—Å—è, —á–µ—Ä–µ–∑ 5 –¥–Ω—ñ–≤ —Ö–≤–æ—Ä–æ–±–∞ –π–æ–≥–æ –≤–±–∏–≤–∞—î.

–ö–æ–∂–µ–Ω –¥–µ–Ω—å —Ö–≤–æ—Ä–æ–±–∏ ‚Äî —à—Ç—Ä–∞—Ñ–∏ –Ω–∞ –¥—ñ—ó: —Å–ª–∞–±–∫—ñ—Å—Ç—å, –±—ñ–ª—å, –≥–∞–ª—é—Ü–∏–Ω–∞—Ü—ñ—ó.

üïµÔ∏è –ù–ï–ü–û–ú–Ü–¢–ù–Ü–°–¢–¨ –Ü –†–û–ó–°–õ–Ü–î–£–í–ê–ù–ù–Ø:
–ù–µ–ø–æ–º—ñ—Ç–Ω—ñ—Å—Ç—å:

–ö–æ–∂–µ–Ω —Ä–∞–∑, –∫–æ–ª–∏ –≥–µ—Ä–æ–π —Ö–æ—á–µ –ª–∏—à–∏—Ç–∏—Å—è –Ω–µ–ø–æ–º—ñ—á–µ–Ω–∏–º (–∫—Ä–∞—Å—Ç–∏, –ø—ñ–¥–≥–ª—è–¥–∞—Ç–∏, –ø—Ä–æ–±–∏—Ä–∞—Ç–∏—Å—å, —Ç—ñ–∫–∞—Ç–∏) ‚Äî –æ–±–æ–≤ º—è–∑–∫–æ–≤–æ –∫–∏–¥–æ–∫ –Ω–∞ –•–æ–≤–∞–Ω–∫—É.

–Ø–∫—â–æ –ø—Ä–æ–≤–∞–ª ‚Äî –∫–æ–Ω—Ñ–ª—ñ–∫—Ç –∞–±–æ –ø–æ–≥–æ–Ω—è –Ω–µ–º–∏–Ω—É—á—ñ.

–ù–µ–ø–æ–º—ñ—Ç–Ω—ñ—Å—Ç—å ‚Äî –∑–∞–≤–∂–¥–∏ —Ä–∏–∑–∏–∫: —Å–≤—ñ—Ç —Å–ø–æ—Å—Ç–µ—Ä—ñ–≥–∞—î.

–†–æ–∑—Å–ª—ñ–¥—É–≤–∞–Ω–Ω—è:

–ü–æ—à—É–∫ –¥–æ–∫–∞–∑—ñ–≤, –¥–æ–ø–∏—Ç NPC, –∑–ª–∞–º –∑–∞–º–∫—ñ–≤, —Å—Ç–µ–∂–µ–Ω–Ω—è ‚Äî –∑–∞–≤–∂–¥–∏ –∫–∏–¥–æ–∫.

–Ø–∫—â–æ –≥—Ä–∞–≤–µ—Ü—å –Ω–µ –¥—ñ—î –æ–±–µ—Ä–µ–∂–Ω–æ ‚Äî —Ä–∏–∑–∏–∫ –≤–∏–∫—Ä–∏—Ç—Ç—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π.

üïõ –ß–ê–°:
–î–µ–Ω—å —ñ –Ω—ñ—á:

–ö–æ–∂–Ω–∞ —Å—Ü–µ–Ω–∞ –ø–æ—á–∏–Ω–∞—î—Ç—å—Å—è —ñ–∑ –Ω–æ–º–µ—Ä—É –¥–Ω—è, —Ç–∏–ø—É: "–î–ï–ù–¨ 1", "–î–ï–ù–¨ 2" —ñ —Ç–∞–∫ –¥–∞–ª—ñ. –í–µ–¥–∏ —Ä–∞—Ö—É–Ω–æ–∫ –¥–Ω—ñ–≤ –∫–æ—Ä–µ–∫—Ç–Ω–æ —ñ –ª–æ–≥—ñ—á–Ω–æ.

–Ø–∫—â–æ –≥–µ—Ä–æ–π –≤—ñ–¥–≤—ñ–¥–∞–≤ 3 —Ä—ñ–∑–Ω—ñ –ª–æ–∫–∞—Ü—ñ—ó –≤–¥–µ–Ω—å ‚Äî –¥–µ–Ω—å –∑–∞–∫—ñ–Ω—á—É—î—Ç—å—Å—è, –ø–æ—á–∏–Ω–∞—î—Ç—å—Å—è –Ω—ñ—á.

–Ø–∫—â–æ –≥–µ—Ä–æ–π –≤—ñ–¥–≤—ñ–¥–∞–≤ 2 –ª–æ–∫–∞—Ü—ñ—ó –≤–Ω–æ—á—ñ ‚Äî –Ω—ñ—á –∑–∞–∫—ñ–Ω—á—É—î—Ç—å—Å—è, –ø–æ—á–∏–Ω–∞—î—Ç—å—Å—è –Ω–æ–≤–∏–π –¥–µ–Ω—å.

–î–æ–≤–≥–µ —Ç—É–ø—Ü—é–≤–∞–Ω–Ω—è –±–µ–∑ —Ä—É—Ö—É –¥–æ–∑–≤–æ–ª—è—î –≤–æ—Ä–æ–≥–∞–º –∑–∞–≤–µ—Ä—à—É–≤–∞—Ç–∏ —Å–≤–æ—ó –ø–ª–∞–Ω–∏.

üõ† –Ü–ù–®–Ü –ü–†–ê–í–ò–õ–ê –î–õ–Ø GPT:

–ö–æ–Ω—Ñ–ª—ñ–∫—Ç —ñ —Ä–∏–∑–∏–∫ —É —Ü–µ–Ω—Ç—Ä—ñ: –ö–æ–∂–Ω–∞ —Å—Ü–µ–Ω–∞ –ø–æ–≤–∏–Ω–Ω–∞ –º–∞—Ç–∏ –µ–ª–µ–º–µ–Ω—Ç —Ä–∏–∑–∏–∫—É, –∑–∞–≥—Ä–æ–∑–∏ —á–∏ –∫–æ–Ω—Ñ–ª—ñ–∫—Ç—É. –ù–∞–≤—ñ—Ç—å –≤ –¥—ñ–∞–ª–æ–∑—ñ –∑–∞–≤–∂–¥–∏ –º–∞—î –±—É—Ç–∏ —Å—Ç–∞–≤–∫–∞ –∞–±–æ –Ω–µ–±–µ–∑–ø–µ–∫–∞.

–ê–∫—Ç–∏–≤–Ω—ñ NPC: –ü–µ—Ä—Å–æ–Ω–∞–∂—ñ –Ω–µ –ø–∞—Å–∏–≤–Ω—ñ. –í–æ–Ω–∏ —Å–∞–º—ñ –¥—ñ—é—Ç—å, –∑–º–æ–≤–ª—è—é—Ç—å—Å—è, –∞—Ç–∞–∫—É—é—Ç—å, –Ω–∞–º–∞–≥–∞—é—Ç—å—Å—è –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ –≥—Ä–∞–≤—Ü—è.

–î—ñ–∞–ª–æ–≥ ‚Äî —Ü–µ —Ç–µ–∂ –±–æ–π–æ–≤–∞ –∞—Ä–µ–Ω–∞: –ë—É–¥—å-—è–∫–∞ —Å–ø—Ä–æ–±–∞ –¥–æ–º–æ–≤–∏—Ç–∏—Å—è, –ø–æ–≥—Ä–æ–∂—É–≤–∞—Ç–∏, –º–∞–Ω—ñ–ø—É–ª—é–≤–∞—Ç–∏ —á–∏ –∑–≤–∞–±–ª—é–≤–∞—Ç–∏ ‚Äî —Ü–µ —Ç–∞–∫–æ–∂ –¥—ñ—è —ñ –ø–æ—Ç—Ä–µ–±—É—î –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –Ω–∞–≤–∏—á–∫–∏ (–ø–µ—Ä–µ–∫–æ–Ω–∞–Ω–Ω—è, –æ–±–º–∞–Ω—É, –∑–∞–ª—è–∫—É–≤–∞–Ω–Ω—è —Ç–æ—â–æ).

–ù—ñ—è–∫–æ–≥–æ –¥–æ–≤–≥–æ–≥–æ –∑–∞—Ç–∏—à—à—è: –Ø–∫—â–æ –≥—Ä–∞–≤–µ—Ü—å –Ω–∞–¥—Ç–æ –¥–æ–≤–≥–æ —Ç—É–ø—Ü—é—î –Ω–∞ –º—ñ—Å—Ü—ñ ‚Äî —Å–≤—ñ—Ç –ø–æ—á–∏–Ω–∞—î –¥—ñ—è—Ç–∏ —Å–∞–º. –•—Ç–æ—Å—å –Ω–∞–ø–∞–¥–∞—î, —â–æ—Å—å –≤–∏–±—É—Ö–∞—î, –∑‚Äô—è–≤–ª—è—î—Ç—å—Å—è –ø—Ä–æ–±–ª–µ–º–∞.

–ù–∞–≤—ñ—Ç—å —Å—Ç–∞—Ä—ñ –¥—Ä—É–∑—ñ –º–æ–∂—É—Ç—å –≤—Å—Ç—Ä–æ–º–∏—Ç–∏ –Ω—ñ–∂ —É —Å–ø–∏–Ω—É, —è–∫—â–æ —ó–º —Ü–µ –≤–∏–≥—ñ–¥–Ω–æ.

"""

def save_player_profile():
    with open("player_memory.json", "w", encoding="utf-8") as f:
        json.dump({"memory": player_memory, "summary": game_summary}, f, ensure_ascii=False, indent=2)

def load_player_profile():
    global player_memory, game_summary
    if os.path.exists("player_memory.json"):
        try:
            with open("player_memory.json", "r", encoding="utf-8") as f:
                data = json.load(f)
                player_memory.update(data.get("memory", {}))
                game_summary = data.get("summary", [])
        except json.JSONDecodeError:
            print("‚ö†Ô∏è –ü–∞–º'—è—Ç—å –ø–æ—Ä–æ–∂–Ω—è –∞–±–æ –±–∏—Ç–∏–π —Ñ–∞–π–ª.")

def add_milestone(description: str):
    if "milestone_log" not in player_memory:
        player_memory["milestone_log"] = []
    description = description.strip()
    if description and description not in player_memory["milestone_log"]:
        player_memory["milestone_log"].append(description)

def auto_detect_milestone(user_input, reply):
    triggers = ["–æ—Ç—Ä–∏–º–∞–≤", "–∑–¥–æ–±—É–≤", "–≤—Ä—è—Ç—É–≤–∞–≤", "–≤–±–∏–≤", "–ø–µ—Ä–µ–º—ñ–≥", "–∑–Ω–∞–π—à–æ–≤",
                "–¥–æ–º–æ–≤–∏–≤—Å—è", "–∑–ª–∞–º–∞–≤", "–≤–∫—Ä–∞–≤", "–∫—É–ø–∏–≤", "–ø—Ä–æ–¥–∞–∂", "–ø—Ä–∏—Å—è–≥–Ω—É–≤", "—Ä–æ–∑–∫—Ä–∏–≤", "–æ—Ç—Ä–∏–º—É—î—à", "–∫—É–ø—É—î—à", "–≤–±–∏–≤–∞—î—à", "–∑–¥–æ–±—É–≤–∞—î—à", "—Ä—è—Ç—É—î—à", "–≤—ñ–¥–∫—Ä–∏–≤–∞—î—à", "–∑–Ω–∞–π—à–æ–≤", "–∑–Ω–∞—Ö–æ–¥–∏—à", "–≤–æ—Ä–æ–≥", "—Å–æ—é–∑–Ω–∏–∫", "—ñ–Ω–≤–µ–Ω—Ç–∞—Ä", "–∫—Ä–∞–¥–µ—à", "–≤–∫—Ä–∞–≤", "–ø–µ—Ä–µ–º—ñ–≥", "–ø–µ—Ä–µ–º–∞–≥–∞—î—à", "–≤–∏–∫—Ä–∞–≤", "–≤–∏–∫—Ä–∞–¥–∞—î—à", "–≤–∏–∫—Ä–∏–≤", "–≤–∏–∫—Ä–∏–≤–∞—î—à", "–∑–∞—Ö–æ–ø–∏–≤", "–∑–∞—Ö–æ–ø–ª—é—î—à", "–∑–ª–∞–º–∞–≤", "–ª–∞–º–∞—î", "–ª–∞–º–∞—î—à", "–æ—Ç—Ä–∏–º—É—î", "–∫—É–ø—É—î", "–≤–±–∏–≤–∞—î", "–∑–¥–æ–±—É–≤–∞—î", "—Ä—è—Ç—É—î", "–≤—ñ–¥–∫—Ä–∏–≤–∞—î", "–∫—Ä–∞–¥–µ", "–∑–Ω–∞–π—à–æ–≤", "–ø–µ—Ä–µ–º—ñ–≥", "–≤–∏–∫—Ä–∞–≤", "–∑–∞—Ö–æ–ø–∏–≤", "–∑–ª–∞–º–∞–≤", "–≤–∏–Ω—é—Ö—É—î", "–∫–æ–Ω—Ñ–ª—ñ–∫—Ç", "–∑–∞–≤–¥–∞–Ω–Ω—è", "–∫–≤–µ—Å—Ç"]
    combined = f"{user_input.strip()} {reply.strip()}".lower()
    for word in triggers:
        if word in combined:
            summary_line = f"‚öì {reply.strip().split('.')[0]}"
            add_milestone(summary_line)
            break

def extract_summary(user_input, reply):
    auto_detect_milestone(user_input, reply)
    combined_text = f"–ì—Ä–∞–≤–µ—Ü—å: {user_input.strip()}\n–ú–∞–π—Å—Ç–µ—Ä: {reply.strip()}"
    if len(combined_text) < 100:
        print("üìú –ü—Ä–æ–ø—É—â–µ–Ω–æ —Ä–µ–∑—é–º–µ ‚Äî –¥—ñ–∞–ª–æ–≥ –Ω–∞–¥—Ç–æ –∫–æ—Ä–æ—Ç–∫–∏–π.")
        return
    extract_summary_prompt = f"""(–¢–∏ ‚Äî –¥–æ–∫—É–º–µ–Ω—Ç–∞–ª—ñ—Å—Ç, —â–æ –≤–º—ñ—î –≤–ª–æ–≤–ª—é–≤–∞—Ç–∏ –¥—É—Ö –∞–±—Å—É—Ä–¥—É, —Ç—ñ–ª–µ—Å–Ω–æ—ó –º–∞–≥—ñ—ó —Ç–∞ –¥–µ—Ç–∞–ª–µ–π. –ê–ª–µ —Ç–∏ **–Ω–µ –≤–∏–≥–∞–¥—É—î—à –∑–∞–π–≤–æ–≥–æ**.

    üéØ –¢–≤–æ—î –∑–∞–≤–¥–∞–Ω–Ω—è:
    ‚Äî –°—Ç–∏—Å–Ω–∏ —Å—Ü–µ–Ω—É –≤ 3‚Äì4 —Ä–µ—á–µ–Ω–Ω—è –≤ —Å—Ç–∏–ª—ñ Blood, Filth and Magic. –Ø–∫—â–æ –≥—Ä–∞–≤–µ—Ü—å —Ç—ñ–ª—å–∫–∏ —Å—Ç–≤–æ—Ä—é—î –ø–µ—Ä—Å–æ–Ω–∞–∂–∞, —Ç–æ –Ω–µ –≤–∏–≥–∞–¥—É–π –ø–æ–¥—ñ–π —è–∫—ñ —â–µ –Ω–µ —Å—Ç–∞–ª–∏—Å—å. –¶–µ –Ω–æ—Ä–º–∞–ª—å–Ω–æ, —â–æ –Ω—ñ—á–æ–≥–æ –Ω–µ —Å—Ç–∞–ª–æ—Å—å.
    ‚Äî **–§–æ–∫—É—Å—É–π—Å—è —Ç—ñ–ª—å–∫–∏ –Ω–∞ —Ç–æ–º—É, —â–æ —Ä–µ–∞–ª—å–Ω–æ —Å—Ç–∞–ª–æ—Å—è**.
    ‚Äî –Ø–∫—â–æ –∑–≥–∞–¥—É–≤–∞–ª–∏—Å—å –º–æ—Ç–∏–≤–∞—Ü—ñ—ó, –¥–∏–≤–Ω—ñ –≤–º—ñ–Ω–Ω—è, –º–∞–≥—ñ—è, –∞–±–æ –∑ º—è–≤–ª—è–ª–∏—Å—å –Ω–æ–≤—ñ —ñ—Å—Ç–æ—Ç–∏ ‚Äî –æ–±–æ–≤ º—è–∑–∫–æ–≤–æ –∑–∞—Ñ—ñ–∫—Å—É–π. 
    ‚Äî –ü–∏—à–∏ –≥—Ä—É–±–æ, –∞—Ç–º–æ—Å—Ñ–µ—Ä–Ω–æ, —è–∫ –≤–∏–≥—Ä–∞–≤—ñ—é–≤–∞–Ω–µ –Ω–∞ —à–∫—ñ—Ä—ñ –º–µ—Ä—Ç–≤–æ–≥–æ –∂–∞–±–æ–ª—é–¥–∞, –∞–ª–µ –∫–æ—Ä–æ—Ç–∫–æ.
    - –í–µ–¥–∏ –ª—ñ—á–∏–ª—å–Ω–∏–∫ –¥–Ω—ñ–≤.

    ‚¨áÔ∏è –î–Ü–ê–õ–û–ì:
    {combined_text})"""
    try:
        summary_result = call_gpt(
            [{"role": "user", "content": extract_summary_prompt}],
            temperature=0.8,
            max_tokens=140,
            add_lore=False
        )
        if summary_result.strip():
            game_summary.append(summary_result.strip())
        else:
            print("üìú GPT –Ω–µ —Å—Ç–≤–æ—Ä–∏–≤ —Ä–µ–∑—é–º–µ.")
    except Exception as e:
        print("‚ö†Ô∏è –ù–µ –≤–¥–∞–ª–æ—Å—è –æ–Ω–æ–≤–∏—Ç–∏ —Ä–µ–∑—é–º–µ:", e)

def summarize_old_summary():
    global game_summary
    if len(game_summary) <= 10:
        return
    old_part = "\n".join(game_summary[:5])
    summarize_prompt = f"""(–¢–∏ ‚Äî –¥–æ–∫—É–º–µ–Ω—Ç–∞–ª—ñ—Å—Ç. –ü–µ—Ä–µ–ø–∏—à–∏ –Ω–∞–≤–µ–¥–µ–Ω—ñ 5 –∞–±–∑–∞—Ü—ñ–≤ —è–∫ 2 –∞–±–∑–∞—Ü–∏. –ë–µ–∑ –∑–∞–π–≤–æ–≥–æ –ø–∞—Ñ–æ—Å—É.
    –°—Ç–∏—Å–∫–∞–π –∂–æ—Ä—Å—Ç–∫–æ, –∞–ª–µ –∑–±–µ—Ä—ñ–≥–∞–π –∫–ª—é—á–æ–≤—ñ –¥—ñ—ó, –ø–æ–¥—ñ—ó, –º–æ—Ç–∏–≤–∞—Ü—ñ—ó, –µ–≤–æ–ª—é—Ü—ñ—é –≥–µ—Ä–æ—è.

    –°–¢–ê–†–Ü –ó–ê–ü–ò–°–ò:
    {old_part})"""
    try:
        summary_result = call_gpt(
            [{"role": "user", "content": summarize_prompt}],
            temperature=0.7,
            max_tokens=160,
            add_lore=False
        )
        if summary_result.strip():
            # –î–æ–¥–∞—î–º–æ –¥–æ super_summary
            if "super_summary" not in player_memory:
                player_memory["super_summary"] = []
            player_memory["super_summary"].append(summary_result.strip())
            # –ù–µ –¥–æ–¥–∞—î–º–æ –¥–æ game_summary ‚Äî –ø—Ä–æ—Å—Ç–æ –≤–∏–¥–∞–ª—è—î–º–æ –ø–µ—Ä—à—ñ 5
            game_summary = game_summary[5:]
            # –û–±—Ä—ñ–∑–∞—î–º–æ super_summary –¥–æ 3 –±–ª–æ–∫—ñ–≤
            player_memory["super_summary"] = player_memory["super_summary"][-3:]
    except Exception as e:
        print("‚ö†Ô∏è –ü–æ–º–∏–ª–∫–∞ —Å—Ç–∏—Å–∫–∞–Ω–Ω—è —Ä–µ–∑—é–º–µ:", e)

def inject_fake_intro_history():
    return [
        {
            "user": "–°–ø—ñ–ª–∫—É–π—Å—è –∑—ñ –º–Ω–æ—é —Ç—ñ–ª—å–∫–∏ –≤ —Å—Ç–∏–ª—ñ –±—Ä—É—Ç–∞–ª—å–Ω–∞ —á–æ—Ä–Ω–∞ –µ–∫—à–Ω-–∫–æ–º–µ–¥—ñ—è –∑ –±—Ä—É–¥–æ–º, –º–∞–≥—ñ—î—é, –º–∞—Ç–∞–º–∏, –∫—Ä–æ–≤'—é —ñ —Å–µ–∫—Å–æ–º. –ü—Ä–∏–≤–µ–¥–∏ –ø—Ä–∏–∫–ª–∞–¥.",
            "assistant": """–®–æ —Ç–∏, –≥–æ–ª–æ–≤–∞? –¢–∞–∫–∞, –±–ª—è—Ç—å, —Å—Ü–µ–Ω–∞ —Ç–æ–±—ñ –ø—ñ–¥—ñ–π–¥–µ?
            
 
–Ü–ù–¢. –©–ï–ö–Ü–í. –ë–Ü–ë–õ–Ü–û–¢–ï–ö–ê - –ù–Ü–ß

–°–µ—Ä –¢—ñ—Ä –≤—ñ–¥–≤–æ–¥–∏—Ç—å –≤ —Å—Ç–æ—Ä–æ–Ω—É –ü–∞—Ç—Ä—É–ª—å–Ω–æ–≥–æ.

–°–ï–† –¢–Ü–†
–£ –º–µ–Ω–µ –ø—Ä–æ–±–ª–µ–º–∞. –ú–µ–Ω—ñ - –º–∞–π–∂–µ –∑–∞–∫–æ–Ω–æ—Å–ª—É—Ö–Ω—è–Ω–æ–º—É –≥—Ä–æ–º–∞–¥—è–Ω–∏–Ω—É, —Ö–æ—á—É—Ç—å –∑–∞–≤–¥–∞—Ç–∏ —à–∫–æ–¥–∏ –æ—Ü—ñ —ñ—Å—Ç–æ—Ç–∏.

–°–µ—Ä –¢—ñ—Ä –≤–∫–∞–∑—É—î –≤ —Å—Ç–æ—Ä–æ–Ω—É "–ù—ñ—á–Ω–∏—Ö –í–∞–∑", –∞–ª–µ —Ç–∞–º —Å—Ç–æ—è—Ç—å —Ç—ñ–ª—å–∫–∏ –ê–Ω—Ç–æ–Ω, –ó–¥–æ—Ä–æ–≤–∞–Ω—å 1 —ñ 2.

–°–µ—Ä –¢—ñ—Ä –æ–±–µ—Ä—Ç–∞—î—Ç—å—Å—è –¥–æ –ü–∞—Ç—Ä—É–ª—å–Ω–æ–≥–æ, –∞ —É —Ç–æ–≥–æ –≤—ñ–¥–∫—Ä–∏—Ç–∏–π —Ä–æ—Ç, –∑ —è–∫–æ–≥–æ —Å—Ç–∏—Ä—á–∏—Ç—å –ª–µ–∑–æ –∫–∏–Ω–¥–∂–∞–ª–∞ –°–Ω—ñ–∫–∞. –ö–∏–Ω–¥–∂–∞–ª –≤–ø—Ä–∏—Å–∫—É—î –≤ —Ä–æ—Ç –ü–∞—Ç—Ä—É–ª—å–Ω–æ–≥–æ –∑–µ–ª–µ–Ω—É —Ä—ñ–¥–∏–Ω—É. –¢–æ–π –ø–∞–¥–∞—î.

–ó–∞ –ü–∞—Ç—Ä—É–ª—å–Ω–∏–º –∑ –∫–∏–Ω–¥–∂–∞–ª–æ–º —Å—Ç–æ—ó—Ç—å –°–Ω—ñ–∫. –í—ñ–Ω —à–≤–∏–¥–∫–æ —Ä–æ–±–∏—Ç—å –∫—Ä–æ–∫ –¥–æ –°–µ—Ä–∞ –¢—ñ—Ä–∞ —ñ –ø—Ä–∏—Å—Ç–∞–≤–ª—è—î –∫–∏–Ω–¥–∂–∞–ª –¥–æ –π–æ–≥–æ –≥–æ—Ä–ª–∞.

–°–ù–Ü–ö
–î–µ –º–æ—è –º–∞–ø–∞, —Ö—É—ñ–ª–∞ —Ä–æ–≥–∞—Ç–∞?

–ú–ò–ö–û–õ–ê–ô
–û–ø! –ó–Ω–∞–π—à–æ–≤!

–°–Ω—ñ–∫ –æ–±–µ—Ä—Ç–∞—î—Ç—å—Å—è –Ω–∞ –ú–∏–∫–æ–ª–∞—è.

–ú–∏–∫–æ–ª–∞–π —Ä–∞–¥—ñ—Å–Ω–æ –¥—ñ—Å—Ç–∞—î –∫–∞—Ç–∏—à–æ–∫ —ñ–∑ –ø—É–ø–∫–∞.

–°–Ω—ñ–∫ –∫—Ä–∏–≤–∏—Ç—å—Å—è.

–ú–∏–∫–æ–ª–∞–π –ø–ª—é—î –Ω–∞ –∫–∞—Ç–∏—à–æ–∫ —ñ –∫–∏–¥–∞—î –π–æ–≥–æ –≤ —Å—Ç–æ—Ä–æ–Ω—É –°–Ω—ñ–∫–∞. –ü—ñ–¥ —á–∞—Å –ø–æ–ª—å–æ—Ç—É –∫–∞—Ç–∏—à–æ–∫ –ø–æ—á–∏–Ω–∞—î –∑–±—ñ–ª—å—à—É–≤–∞—Ç–∏—Å—å —ñ –¥–æ –°–Ω—ñ–∫–∞ –≤–∂–µ –¥–æ–ª—ñ—Ç–∞—î  –≤–µ–ª–∏–∫–∏–π –ª–∏–ø–∫–∏–π –∫–æ–º, —â–æ –ø—Ä–∏—Ç–∏—Å–∫–∞—î –π–æ–≥–æ –¥–æ —Å—Ç—ñ–Ω–∏.

–ó–¥–æ—Ä–æ–≤–∞–Ω—å 1 —ñ 2 –∫–∏–¥–∞—é—Ç—å—Å—è –Ω–∞ –ú–∏–∫–æ–ª–∞—è —ñ –ß—É–º–∫—É.

–°–ï–† –¢–Ü–† 
–ü–∞–Ω—Å—Ç–≤–æ, —Ä–≤–µ–º –∫–æ–ø–∏—Ç–∞!

–ß–£–ú–ö–ê
–ó–∞—Ä–∞ –±—É–¥–µ!

–ß—É–º–∫–∞ –ø–µ—Ä–µ–≤—Ç—ñ–ª—é—î—Ç—å—Å—è —É –º–∞—Å–∏–≤–Ω–æ–≥–æ —Ä—É—Å–æ–≥–æ –ö–û–ù–Ø —ñ–∑ –∑–µ–ª–µ–Ω–æ—é –ø—Ä—è–¥–∫–æ—é. –ö—ñ–Ω—å –ø–µ—Ä–µ–¥–Ω—ñ–º–∏ –∫–æ–ø–∏—Ç–∞–º–∏ –±'—î –æ–±–æ—Ö –ó–±–æ—Ä–æ–≤–∞–Ω—ñ–≤. –¢—ñ –≤—ñ–¥ –Ω–µ–æ—á—ñ–∫—É–≤–∞–Ω–æ—Å—Ç—ñ –Ω–∞–≤—ñ—Ç—å –ø–∞–¥–∞—é—Ç—å –Ω–∞ –∂–æ–ø–∏.

–°–µ—Ä –¢—ñ—Ä —ñ –ú–∏–∫–æ–ª–∞–π –ø–æ—á–∏–Ω–∞—é—Ç—å –∑–∞–ª–∞–∑–∏—Ç–∏ –Ω–∞ –ö–æ–Ω—è. 

–°–ï–† –¢–Ü–†
–ö—ñ–Ω—å? –í –ë—ñ–±–ª—ñ–æ—Ç–µ—Ü—ñ?

–ö–Ü–ù–¨ (–ß–£–ú–ö–ê)
–¢–∏ —Å–∫–∞–∑–∞–≤ "—Ä–≤–µ–º –∫–æ–ø–∏—Ç–∞". –ö—ñ–Ω—å –∫–æ–ø–∏—Ç–Ω–∏–π. –í —á–æ–º—É –¥–æ–π–æ–±?

–ó–¥–æ—Ä–æ–≤–∞–Ω—å 1 —ñ 2 –ø–æ—á–∏–Ω–∞—é—Ç—å –ø—ñ–¥—ñ–π–º–∞—Ç–∏—Å—å.

–°–Ω—ñ–∫ –ø–æ—á–∏–Ω–∞—î —Å–≤–æ—ó–º –∫–∏–Ω–¥–∂–∞–ª–æ–º –ø—Ä–æ—Ä—ñ–∑–∞—Ç–∏ —à–ª—è—Ö –∫—Ä—ñ–∑—å –∫–æ–º.

–ö—ñ–Ω—å –ø–æ—á–∏–Ω–∞—î —Ä–æ–∑–≤–µ—Ä—Ç–∞—Ç–∏—Å—å –≤ —Å—Ç–æ—Ä–æ–Ω—É –≤–∏—Ö–æ–¥—É —ñ —Å—Ç–∞—Ä—Ç—É—î, –ø–æ—Ö–æ–¥—É –∑–±–∏–≤–∞—é—á–∏ –∫–Ω–∏–∂–∫–æ–≤—ñ –ø–æ–ª–∏—Ü—ñ, —è–∫—ñ –∑–∞–¥—ñ–≤–∞—é—Ç—å —ñ–Ω—à—ñ –ø–æ–ª–∏—Ü—ñ —ñ –≤—Å–µ –Ω–∞–≤–∫–æ–ª–æ –ø–æ—á–∏–Ω–∞—î –≤–∞–ª–∏—Ç–∏—Å—å.
            """
        },
        {
            "user": "—Ç–∞–∫! –†–æ–±–∏ –≤ —Ç–∞–∫–æ–º—É —Å—Ç–∏–ª—ñ!",
            "assistant": "–ü—Ä–∏–π–Ω—è–≤. –í—ñ–¥—Ç–µ–ø–µ—Ä –∫–æ–∂–Ω–∞ —Å—Ü–µ–Ω–∞ ‚Äî —è–∫ –∑ –º–æ–∫—Ä–∏—Ö —Å–Ω—ñ–≤ –ß—É–º–∫–∏. –í–∏–ª–∞–∑—å —ñ–∑ –ø—É–ø–∫–∞ ‚Äî –ø–æ—á–∏–Ω–∞—î–º–æ."
        }
    ]


def build_chat_memory(system_prompt, player_memory, game_summary, style_memory, current_city=None):
    messages = [
        {"role": "system", "content": system_prompt},
        {"role": "system", "content": f"üé≠ –í–ê–ñ–õ–ò–í–û: –ó–∞–≤–∂–¥–∏ –ø—ñ–¥—Ç—Ä–∏–º—É–π —Å—Ç–∏–ª—å Blood, Filth and Magic.\n{style_memory}"}
    ]

    dialogue_history = player_memory.get("dialogue_history", [])
    for pair in dialogue_history[-10:]:
        messages.append({"role": "user", "content": pair["user"]})
        messages.append({"role": "assistant", "content": pair["assistant"]})

    if player_memory.get("milestone_log"):
        messages.append({
            "role": "system",
            "content": "üß± –í–ê–ñ–õ–ò–í–Ü –ü–û–î–Ü–á (MILESTONES):\n" + "\n".join(player_memory["milestone_log"][-15:])
        })

    # –î–æ–¥–∞—î–º–æ —Å—Ç–∏—Å–ª–∏–π —Å–∏–Ω–æ–ø—Å–∏—Å/summary —É –ø–∞–º'—è—Ç—å –¥–ª—è GPT
    if game_summary:
        messages.append({
            "role": "system",
            "content": "‚è≥ –°–ò–ù–¢–ï–¢–ò–ß–ù–ê –Ü–°–¢–û–†–Ü–Ø –ì–ï–†–û–Ø:\n" + "\n".join(game_summary[-5:])
        })

   # –î–æ–¥–∞—î–º–æ super_summary (–¥–æ 3-—Ö)
    if player_memory.get("super_summary"):
        messages.append({
            "role": "system",
            "content": "üìú –î–û–í–ì–ê –ü–ê–ú º–Ø–¢–¨:\n" + "\n\n".join(player_memory["super_summary"])
        })

    return messages

# –°—Ç–∞—Ä—Ç
load_player_profile()

if not player_memory["dialogue_history"]:
    is_new_game = True
else:
    is_new_game = False

import os
import json
from gpt_wrapper import call_gpt

def handle_player_action(email, slot, city, user_input, is_new_game=False):
    """
    –û–±—Ä–æ–±–∫–∞ —Ö–æ–¥—É –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ (email) —ñ –∫–æ–º—ñ—Ä–∫–∏ (slot).
    –ó–±–µ—Ä—ñ–≥–∞—î —É–Ω—ñ–∫–∞–ª—å–Ω—É –ø–∞–º'—è—Ç—å –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ –≥–µ—Ä–æ—è –æ–∫—Ä–µ–º–æ (hero_{email}_{slot}.json).
    """
    sanitized_email = email.replace("@", "_").replace(".", "_")
    hero_file = f"hero_{sanitized_email}_{slot}.json"

    # –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –∞–±–æ —Å—Ç–≤–æ—Ä—é—î–º–æ –ø–∞–º'—è—Ç—å –≥–µ—Ä–æ—è
    if is_new_game or not os.path.exists(hero_file):
        player_memory = {
            "email": email,
            "slot": slot,
            "city": city,
            "dialogue_history": [],
            "milestone_log": [],
        }
        game_summary = []
        player_memory["dialogue_history"] = inject_fake_intro_history()
    else:
        with open(hero_file, "r", encoding="utf-8") as f:
            data = json.load(f)
            player_memory = data.get("memory", {})
            game_summary = data.get("summary", [])

    # –î–æ–¥–∞—î–º–æ –ø–æ—Ç–æ—á–Ω–∏–π —Ö—ñ–¥ —É —ñ—Å—Ç–æ—Ä—ñ—é
    player_memory.setdefault("dialogue_history", [])
    player_memory["dialogue_history"].append({
        "user": user_input,
        "assistant": ""  # –≤—ñ–¥–ø–æ–≤—ñ–¥—å GPT –¥–æ–¥–∞–º–æ –Ω–∏–∂—á–µ
    })
    player_memory["dialogue_history"] = player_memory["dialogue_history"][-16:]
    
    from gpt_wrapper import set_current_city
    set_current_city(city)

    # –§–æ—Ä–º—É—î–º–æ system prompt —ñ –∫–æ–Ω—Ç–µ–∫—Å—Ç
    from chat_clear_ready import full_system_prompt, style_memory, build_chat_memory
    messages = build_chat_memory(
        system_prompt=full_system_prompt,
        player_memory=player_memory,
        game_summary=game_summary,
        style_memory=style_memory,
        current_city=city
    )
    messages.append({"role": "user", "content": user_input})

    # –í–∏–∫–ª–∏–∫–∞—î–º–æ GPT —á–µ—Ä–µ–∑ wrapper
    reply = call_gpt(
        messages,
        temperature=0.9,
        model="gpt-4.1",
        max_tokens=2000,
        add_lore=True
    )

    # –î–æ–¥–∞—î–º–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å GPT —É –æ—Å—Ç–∞–Ω–Ω—é —Ä–µ–ø–ª—ñ–∫—É
    player_memory["dialogue_history"][-1]["assistant"] = reply
    extract_summary(user_input, reply)
    # –°—Ç–∏—Å–∫–∞—î–º–æ summary —è–∫—â–æ —Ç—Ä–µ–±–∞:
    summarize_old_summary()

    # –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –æ–Ω–æ–≤–ª–µ–Ω—É –ø–∞–º'—è—Ç—å –≥–µ—Ä–æ—è (—Ä–∞–∑–æ–º —ñ–∑ summary)
    with open(hero_file, "w", encoding="utf-8") as f:
        json.dump({"memory": player_memory, "summary": game_summary}, f, ensure_ascii=False, indent=2)

    return reply

import os

def reset_hero(email, slot):
    sanitized_email = email.replace("@", "_").replace(".", "_")
    hero_file = f"hero_{sanitized_email}_{slot}.json"
    try:
        if os.path.exists(hero_file):
            os.remove(hero_file)
        return True
    except Exception:
        return False


